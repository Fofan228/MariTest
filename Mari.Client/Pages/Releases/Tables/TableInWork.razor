@using Contracts.Releases
@inject IReleaseManager ReleaseManager
@inject NavigationManager NavigationManager
@inject IPlatformManager PlatformManager
@inject IStatusManager StatusManager
@inject ISnackbar Snackbar

<MudTable Class="mt-8" CanCancelEdit="true" RowEditPreview="BackupItem" RowEditCancel="ResetItemToOriginalValues"
    RowEditCommit="ItemHasBeenCommitted" CommitEditTooltip="Сохранить"
    OnCommitEditClick="@(() => Snackbar.Add("Изменения сохранены"))" EditTrigger="@editTrigger" Items="@Releases"
    Hover="true" T="ReleaseAnswer" OnRowClick="RowClicked">
    <HeaderContent>
        <MudTh>Платформа</MudTh>
        <MudTh>Версия</MudTh>
        <MudTh>Релизная задача</MudTh>
        <MudTh>Статус релиза</MudTh>
        <MudTh>Дата изменения</MudTh>
        <MudTh>Дата завершения</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="PlatformName">@context.PlatformName</MudTd>
        <MudTd DataLabel="Version">@context.Version</MudTd>
        <MudTd DataLabel="ReleaseTask">@context.ReleaseTask</MudTd>
        <MudTd DataLabel="Status">@context.Status</MudTd>
        <MudTd DataLabel="UpdateDate">@context.UpdateDate</MudTd>
        <MudTd DataLabel="CompleteDate">@context.CompleteDate</MudTd>
    </RowTemplate>
    <RowEditingTemplate>
        <MudTd DataLabel="PlatformName">
            @context.PlatformName
        </MudTd>
        <MudTd DataLabel="Version">
            @context.Version
        </MudTd>
        <MudTd DataLabel="ReleaseTask">
            @context.ReleaseTask
        </MudTd>
        <MudTd DataLabel="Status">
            <div @onclick:stopPropagation="true" @onclick:preventDefault="true">
                <MudSelect @bind-Value="@context.Status" Required>
                    @foreach (var item in Statuses)
                    {
                        <MudSelectItem Value="@item">@item</MudSelectItem>
                    }
                </MudSelect>
            </div>
        </MudTd>
        <MudTd DataLabel="UpdateDate">@context.UpdateDate</MudTd>
        <MudTd>
            <div @onclick:stopPropagation="true" @onclick:preventDefault="true">
                <MudDatePicker Class="date-picker" @bind-Date="@context.CompleteDate" Required ErrorText="Неверная дата"
                    Editable="true" Mask="@(new DateMask("dd/MM/yyyy"))" DateFormat="dd/MM/yyyy">
                </MudDatePicker>
            </div>
        </MudTd>
    </RowEditingTemplate>
    <EditButtonContent Context="button">
        <MudIconButton Size="@Size.Small" Icon="@Icons.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction"
            Disabled="@button.ButtonDisabled" />
    </EditButtonContent>
</MudTable>

@code
{
    private TableEditTrigger editTrigger = TableEditTrigger.EditButton;
    private ReleaseAnswer elementBeforeEdit;

    private List<ReleaseAnswer> Releases { get; set; }
    private List<PlatformAnswer> Platforms { get; set; }
    private string[] Statuses { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Releases = await ReleaseManager.GetAll();
        Platforms = await PlatformManager.GetAll();
        Statuses = await StatusManager.GetAll();
    }

    private void RowClicked(TableRowClickEventArgs<ReleaseAnswer> _)
    {
        NavigationManager.NavigateTo("/info");
    }

    private void BackupItem(object release)
    {
        elementBeforeEdit = new ReleaseAnswer
        {
            ReleaseId = ((ReleaseAnswer)release).ReleaseId,
            Version = ((ReleaseAnswer)release).Version,
            PlatformName = ((ReleaseAnswer)release).PlatformName,
            Status = ((ReleaseAnswer)release).Status,
            ReleaseTask = ((ReleaseAnswer)release).ReleaseTask,
            CompleteDate = ((ReleaseAnswer)release).CompleteDate,
            UpdateDate = ((ReleaseAnswer)release).UpdateDate,
            Information = ((ReleaseAnswer)release).Information,
        };
        StateHasChanged();
    }

    private void ResetItemToOriginalValues(object release)
    {
        ((ReleaseAnswer)release).Version = elementBeforeEdit.Version;
        ((ReleaseAnswer)release).PlatformName = elementBeforeEdit.PlatformName;
        ((ReleaseAnswer)release).Status = elementBeforeEdit.Status;
        ((ReleaseAnswer)release).ReleaseTask = elementBeforeEdit.ReleaseTask;
        ((ReleaseAnswer)release).CompleteDate = elementBeforeEdit.CompleteDate;
        StateHasChanged();
    }

    private void ItemHasBeenCommitted(object release)
    {
        StateHasChanged();
    }
}