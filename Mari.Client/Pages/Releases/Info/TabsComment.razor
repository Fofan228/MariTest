 @using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using System.Text.RegularExpressions
@using System.Web
@using Humanizer
@using Mari.Client.Common.Interfaces.Formatters
@using Mari.Client.Models.Comments
@using Microsoft.IdentityModel.JsonWebTokens
@inject ICommentManager CommentManager
@inject IDescriptionFormatter DescriptionFormatter
 @inject IDateFormatter DateFormatter
<MudPaper Elevation="0" Class="pt-2"> 
    <MudStack > <!--TODO убрать дублирование кода-->
        @foreach (var comment in UserComments)
            {
                <MudPaper Class="border-b pl-4 pb-4" Elevation="0" Height="20vh">
                        
                    <MudPaper Class=" d-flex" Elevation="0">
                        <MudAvatar Color="Color.Primary">M</MudAvatar>
                        <MudPaper Class="d-flex align-center pl-4" Elevation="0">
                            <MudText>@comment.UserName</MudText>
                        </MudPaper>
                    </MudPaper>

                    <MudPaper Class="pt-1"   Elevation="0">
                         <MudTooltip Text="@DateFormatter.FormatDate(comment.CreateDate)">
                            <MudText Style="font-size: 14px;">@DateFormatter.Humanize(comment.CreateDate)</MudText>
                        </MudTooltip>
                    </MudPaper>

                    <MudPaper Class="pt-2" Elevation="0">
                        <MudText>
                           @DescriptionFormatter.Format(comment.Content)
                        </MudText>
                    </MudPaper>
                </MudPaper>
            }
    </MudStack>
</MudPaper>
 
 
<AuthorizeView>
    <Authorized>
         <MudPaper Elevation="3" Square="true" Class="border-b px-4 py-4 d-flex flex-column" Style="bottom: 0; position: sticky;">
            <MudPaper Class="d-flex" Elevation="0">
                <MudAvatar Color="Color.Primary">M</MudAvatar>
                <MudPaper Class="d-flex align-center pl-4" Elevation="0">
                    <MudText>@context.User.Identity?.Name</MudText>
                </MudPaper>
            </MudPaper>
            <MudForm>
                <MudTextField @bind-Value="@Text" Lines="3" Label="Введите текст" Variant="Variant.Filled" Clearable="true"/>
                <MudPaper Class="d-flex tooltip-comment" Elevation="0">
                    <MudTooltip Text="Обновить" Style="width: auto">
                        <MudIconButton Icon="@Icons.Filled.Refresh" OnClick="Refresh"/>
                    </MudTooltip>
                    <MudButton Class="my-2" OnClick="AddComment" Variant="Variant.Filled" Color="Color.Primary" Style="right: -50%">
                        Отправить
                    </MudButton>
                </MudPaper>
            </MudForm>
        </MudPaper>
    </Authorized>
</AuthorizeView>
 
    
@code {

    [Parameter]
    public string ReleaseId { get; set; } = null!;

    private List<CommentModel> UserComments { get; set; } = new List<CommentModel>();

    private CommentModel NewCommnet { get; set; } = new CommentModel();

    protected override async Task OnInitializedAsync()
    {
       // UserComments = await CommentManager.GetAllUserComment(Guid.Parse(Id));
        
    // TODO Тестовые данные
        UserComments = new List<CommentModel>
        {
            new CommentModel()
            {
                CommentId = Guid.NewGuid(),
                ReleaseId = Guid.NewGuid(),
                UserId = 1,
                UserName = Name,
                Content = "Пошли на хуй \n Пидорасы",
                CreateDate = DateTime.Now,
                IsRedact = false
            }
        };
    }

    string Name { get; set; } = "Ахимат";
    string Text { get; set; }

    private void AddComment()
    {
        //NewCommnet.ReleaseId = new Guid(ReleaseId);
      //  NewCommnet.UserId = userId;
        
        Text = null;
     // CommentManager.Post(newCommnet); 
    // Comments = await CommentManager.GetAllUserComment(Guid.Parse(Id));
        StateHasChanged();
    }
    
    private async Task Refresh()
    {
        // await UpdateReleases();
        // StateHasChanged();
    }
}

